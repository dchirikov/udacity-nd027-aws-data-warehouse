# Project overview

The goal of the project it to design ETL processing pipeline based on AWS RedShift database.
ETL loads data from S3 bucket to 2 staging tables (`staging_events` and `staging_songs`)
and then builds 1 fact table and 4 dimensional table to speed up analytic queries

# Tables schemas

## Staging tables

### `staging_events`

Table `staging_events` is a temporary table stores data about user events from S3 bucket.

| Column Name        | Type                    | Constraints       | Description                             |
|--------------------|-------------------------|-------------------|-----------------------------------------|
| artist             | character varying(200)  |                   | Artist name                             |
| auth               | character varying(10)   |                   | Authentication event                    |
| firstName          | character varying(200)  |                   | User's first name                       |
| gender             | character varying(1)    |                   | User's gender                           |
| itemInSession      | integer                 |                   | Number of events in session             |
| lastName           | character varying(200)  |                   | User's last name                        |
| length             | double precision        |                   | Duration of the song                    |
| level              | character varying(10)   |                   | Membership level                        |
| location           | character varying(200)  |                   | Location of the event                   |
| method             | character varying(10)   |                   | REST method                             |
| page               | character varying(20)   |                   | Requested page                          |
| registration       | double precision        |                   | Timestamp of the registration event     |
| sessionId          | integer                 |                   | ID of the user's session                |
| song               | character varying(200)  |                   | Song title                              |
| status             | integer                 |                   | HTTP status                             |
| ts                 | bigint                  |                   | Timestamp in UNIX format                |
| userAgent          | character varying(200)  |                   | User-agent of the web-client            |
| userId             | character varying(18)   |                   | ID of the user                          |

### `staging_songs`

Table `staging_songs` is a temporary table stores data about available songs.

| Column Name        | Type                    | Constraints       | Description                             |
|--------------------|-------------------------|-------------------|-----------------------------------------|
| num_songs          | bigint                  |                   | Number of songs (service field)         |
| artist_id          | character varying(18)   |                   | ID of the artist                        |
| artist_latitude    | double precision        |                   | Artist's latitude (if available)        |
| artist_longitude   | double precision        |                   | Artist's longitude (if available)       |
| artist_location    | character varying(200)  |                   | Location of the artist                  |
| artist_name        | character varying(200)  |                   | Artist name                             |
| song_id            | character varying(18)   |                   | ID of the song                          |
| title              | character varying(200)  |                   | Song title                              |
| duration           | double precision        |                   | Duration of the song                    |
| year               | integer                 |                   | Year song is released                   |

## Production tables

### Fact table

#### Songplays

Table `songplays` stores information about users' played tracks.

| Column Name        | Type                    | Constraints       | Description                             |
|--------------------|-------------------------|-------------------|-----------------------------------------|
| songplay_id        | bigint                  | IDENTITY(0, 1)    | Autogenerated ID. Primary key.          |
| start_time         | timestamp               | NOT NULL          | Timestamp of the event                  |
| user_id            | character varying(18)   | NOT NULL          | ID of the user                          |
| level              | character varying(10)   | NOT NULL          | Membership level                        |
| song_id            | character varying(18)   |                   | ID of the song                          |
| artist_id          | character varying(18)   |                   | ID if the artist                        |
| session_id         | integer                 | NOT NULL          | ID of the user's session                |
| location           | character varying(200)  |                   | Location of the event                   |
| user_agent         | character varying(200)  |                   | User-agent of the web-client            |

### Dimensional tables

#### `users`

Table stores information about registered users

| Column Name        | Type                    | Constraints       | Description                             |
|--------------------|-------------------------|-------------------|-----------------------------------------|
| user_id            | character varying(18)   | NOT NULL          | ID of the user                          |
| first_name         | character varying(200)  |                   | User's first name                       |
| last_name          | character varying(200)  |                   | User's last name                        |
| gender             | character varying(1)    |                   | Gender                                  |
| level              | character varying(5)    | NOT NULL          | Membership level                        |

#### `songs`

Table stores information about available songs

| Column Name        | Type                    | Constraints       | Description                             |
|--------------------|-------------------------|-------------------|-----------------------------------------|
| song_id            | character varying(18)   | NOT NULL          | ID of the song                          |
| title              | character varying(200)  | NOT NULL          | Title                                   |
| artist_id          | character varying(200)  | NOT NULL          | ID of the artist                        |
| year               | integer                 | NOT NULL DISTKEY  | Year song released                      |
| duration           | double precision        | NOT NULL          | Duration of the song                    |


#### `artists`

Stores information about artists of the songs

| Column Name        | Type                    | Constraints       | Description                             |
|--------------------|-------------------------|-------------------|-----------------------------------------|
| artist_id          | character varying(18)   | NOT NULL          | ID of the artist                        |
| name               | character varying(200)  | NOT NULL          | Artist name                             |
| location           | character varying(200)  |                   | Location of the artist                  |
| latitude           | double precision        |                   | Latitude (if available)                 |
| longitude          | double precision        |                   | Longitude (if available)                |

#### `time`

Stores detailed information about time events

| Column Name        | Type                    | Constraints       | Description                             |
|--------------------|-------------------------|-------------------|-----------------------------------------|
| start_time         | timestamp               | NOT NULL SORTKEY  | Timestamp of the event                  |
| hour               | smallint                | NOT NULL          | Hour of the event                       |
| day                | smallint                | NOT NULL          | Day of the event                        |
| week               | smallint                | NOT NULL          | Week of the event                       |
| month              | smallint                | NOT NULL          | Month of the event                      |
| year               | smallint                | NOT NULL          | Year of the event                       |
| weekday            | smallint                | NOT NULL          | Week day  of the event                  |

# Project files

- `README.md` current file
- `create_tables.py` file stores function to create and cleanup datastore.
- `sql_queries.py` stores tables definitions and string templates of SQL queries
- `etl.py` describes ELT pipeline
- `requirements.txt` Python requirements
- `dwh.cfg` is not part of the repo, but required to run ELT. Format of the file::

        [AWS]
        KEY=
        SECRET=

        [CLUSTER]
        HOST=
        DB_NAME=
        DB_USER=
        DB_PASSWORD=
        DB_PORT=

        [IAM_ROLE]
        ARN=

        [S3]
        LOG_DATA=s3://udacity-dend/log-data
        LOG_JSONPATH=s3://udacity-dend/log_json_path.json
        SONG_DATA=s3://udacity-dend/song-data

# How to run

- `make test` creates database and fills with provided data
- `make pep8` checks PEP8 compliance
- `make jupyter` runs Jupyter Notebook

